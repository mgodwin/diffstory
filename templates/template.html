<!DOCTYPE html>
<html lang="en" data-diffstory-version="__DIFFSTORY_VERSION__">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diffstory Review</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Warm paper palette */
      --bg-primary: #1a1814;
      --bg-secondary: #242019;
      --bg-tertiary: #2e2a24;
      --bg-elevated: #38332b;
      --border-color: #4a443a;
      --border-subtle: #3a352d;

      /* Text hierarchy */
      --text-primary: #f5f0e8;
      --text-secondary: #b8ae9c;
      --text-muted: #7d7567;

      /* Accent palette */
      --accent-amber: #e8a945;
      --accent-amber-dim: rgba(232, 169, 69, 0.15);
      --accent-emerald: #5cb88f;
      --accent-emerald-dim: rgba(92, 184, 143, 0.12);
      --accent-coral: #e86b5c;
      --accent-coral-dim: rgba(232, 107, 92, 0.12);
      --accent-lavender: #a88fd4;
      --accent-lavender-dim: rgba(168, 143, 212, 0.12);
      --accent-sky: #6ba8d4;
      --accent-sky-dim: rgba(107, 168, 212, 0.12);

      /* Diff colors */
      --diff-add-bg: rgba(92, 184, 143, 0.08);
      --diff-add-text: #5cb88f;
      --diff-del-bg: rgba(232, 107, 92, 0.08);
      --diff-del-text: #e86b5c;

      /* Typography */
      --font-display: 'Fraunces', Georgia, serif;
      --font-body: 'DM Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', monospace;

      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 40px;
      --space-2xl: 64px;

      /* Animation */
      --ease-out: cubic-bezier(0.22, 1, 0.36, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Subtle grain texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 1000;
    }

    /* ========== TAB NAVIGATION ========== */
    .tab-bar-wrapper {
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .tab-bar {
      display: flex;
      align-items: center;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
      padding: 0 var(--space-xl);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .tab-bar-brand {
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin-right: var(--space-xl);
      padding: var(--space-md) 0;
      gap: 1px;
    }
    .tab-bar-brand-name {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.2em;
      color: var(--text-muted);
    }
    .tab-bar-brand-audience {
      font-size: 9px;
      color: var(--accent-lavender);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tab {
      position: relative;
      padding: var(--space-md) var(--space-lg);
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      transition: color 0.2s var(--ease-out);
      border: none;
      background: none;
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: var(--space-lg);
      right: var(--space-lg);
      height: 2px;
      background: var(--accent-amber);
      transform: scaleX(0);
      transition: transform 0.3s var(--ease-out);
    }

    .tab:hover { color: var(--text-secondary); }

    .tab.active {
      color: var(--text-primary);
    }

    .tab.active::after {
      transform: scaleX(1);
    }

    /* ========== MAIN CONTENT ========== */
    .content {
      padding: var(--space-xl) var(--space-xl) var(--space-2xl);
      max-width: 1440px;
      margin: 0 auto;
      animation: fadeIn 0.4s var(--ease-out);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========== OVERVIEW TAB ========== */
    .overview-header {
      margin-bottom: var(--space-xl);
    }

    .overview-title {
      font-family: var(--font-display);
      font-size: 42px;
      font-weight: 300;
      line-height: 1.2;
      letter-spacing: -0.02em;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-md);
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .badge.high {
      background: var(--accent-coral-dim);
      color: var(--accent-coral);
      border: 1px solid rgba(232, 107, 92, 0.25);
    }
    .badge.high::before { background: var(--accent-coral); }

    .badge.medium {
      background: var(--accent-amber-dim);
      color: var(--accent-amber);
      border: 1px solid rgba(232, 169, 69, 0.25);
    }
    .badge.medium::before { background: var(--accent-amber); }

    .badge.low {
      background: var(--accent-emerald-dim);
      color: var(--accent-emerald);
      border: 1px solid rgba(92, 184, 143, 0.25);
    }
    .badge.low::before { background: var(--accent-emerald); }

    /* Knowledge level badges */
    .badge.knowledge {
      background: var(--accent-lavender-dim);
      color: var(--accent-lavender);
      border: 1px solid rgba(168, 143, 212, 0.25);
    }
    .badge.knowledge::before { background: var(--accent-lavender); }

    /* Approach evaluation badges */
    .verdict-scale {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: 13px;
      letter-spacing: 0.02em;
      color: var(--text-muted);
    }
    .verdict-scale .verdict-bracket {
      color: var(--text-muted);
      font-weight: 400;
    }
    .verdict-scale .verdict-sep {
      color: var(--border-color);
      margin: 0 2px;
    }
    .verdict-scale .verdict-option {
      font-weight: 400;
    }
    .verdict-scale .verdict-option.verdict-active {
      font-weight: 700;
    }
    .verdict-scale .verdict-option.verdict-active.verdict-optimal {
      color: var(--accent-emerald);
    }
    .verdict-scale .verdict-option.verdict-active.verdict-acceptable {
      color: var(--accent-amber);
    }
    .verdict-scale .verdict-option.verdict-active.verdict-suboptimal {
      color: var(--accent-coral);
    }

    .section-subheading {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-top: var(--space-md);
      margin-bottom: var(--space-sm);
    }
    .approach-alternatives {
      margin-top: 0;
      padding: 0;
      list-style: none;
    }
    .approach-alternatives li {
      position: relative;
      padding-left: var(--space-lg);
      margin-bottom: var(--space-sm);
    }
    .approach-alternatives li::before {
      content: '—';
      position: absolute;
      left: 0;
      color: var(--text-muted);
    }
    .approach-alt-title {
      font-weight: 600;
      color: var(--text-primary);
    }
    .approach-alt-desc {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .perspective-cards { margin-top: var(--space-md); display: flex; flex-direction: column; gap: var(--space-sm); }
    .perspective-card { display: flex; align-items: baseline; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); border-left: 3px solid; font-size: 14px; border-radius: 0 6px 6px 0; }
    .perspective-card.maintainer { border-color: var(--text-muted); background: rgba(139, 148, 158, 0.06); }
    .perspective-card.security  { border-color: var(--accent-coral); background: var(--accent-coral-dim); }
    .perspective-card.sre       { border-color: var(--accent-amber); background: var(--accent-amber-dim); }
    .perspective-card.spec      { border-color: var(--accent-lavender); background: var(--accent-lavender-dim); }
    .perspective-card.consumer  { border-color: var(--accent-sky); background: var(--accent-sky-dim); }
    .perspective-label { font-family: var(--font-mono); font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; flex-shrink: 0; min-width: 72px; }
    .perspective-card.maintainer .perspective-label { color: var(--text-muted); }
    .perspective-card.security .perspective-label  { color: var(--accent-coral); }
    .perspective-card.sre .perspective-label       { color: var(--accent-amber); }
    .perspective-card.spec .perspective-label      { color: var(--accent-lavender); }
    .perspective-card.consumer .perspective-label  { color: var(--accent-sky); }
    .perspective-severity { font-family: var(--font-mono); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-left: auto; flex-shrink: 0; }
    .perspective-severity.high { color: var(--accent-coral); }
    .perspective-severity.medium { color: var(--accent-amber); }
    .perspective-severity.low { color: var(--accent-emerald); }

    .criticality-reasons {
      margin: 0;
      padding: 0;
      list-style: none;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .criticality-reasons li {
      position: relative;
      padding-left: var(--space-lg);
      margin-bottom: var(--space-xs);
    }

    .criticality-reasons li::before {
      content: '—';
      position: absolute;
      left: 0;
      color: var(--text-muted);
    }

    /* Summary card */
    .summary {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
      position: relative;
      overflow: hidden;
    }

    .summary::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: linear-gradient(180deg, var(--accent-amber) 0%, var(--accent-coral) 100%);
    }

    .summary h3 {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: var(--space-md);
    }

    /* Narrative TOC */
    .narrative-toc-item {
      padding: var(--space-md) 0;
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: background 0.15s var(--ease-out);
    }

    .narrative-toc-item:last-child { border-bottom: none; }

    .narrative-toc-item:hover {
      background: var(--bg-tertiary);
      margin: 0 calc(-1 * var(--space-lg));
      padding-left: var(--space-lg);
      padding-right: var(--space-lg);
    }

    .narrative-toc-title {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: var(--space-xs);
    }

    .narrative-toc-summary {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* Test Coverage */
    .coverage-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .coverage-section h3 {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: var(--space-md);
    }

    .coverage-item {
      display: grid;
      grid-template-columns: 90px 1fr auto;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .coverage-item:last-child { border-bottom: none; }

    .coverage-status {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .coverage-status.covered { color: var(--accent-emerald); }
    .coverage-status.partial { color: var(--accent-amber); }
    .coverage-status.uncovered { color: var(--accent-coral); }

    .coverage-file {
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-primary);
    }

    .coverage-notes {
      color: var(--text-muted);
      font-size: 13px;
      font-style: italic;
    }

    /* Side Effects */
    .side-effects-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: var(--space-lg);
      margin-bottom: var(--space-lg);
    }

    .side-effects-section h3 {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: var(--space-md);
    }

    .side-effect-item {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: var(--space-md);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .side-effect-item:last-child { border-bottom: none; }

    .side-effect-area {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .side-effect-area.high { color: var(--accent-coral); }
    .side-effect-area.medium { color: var(--accent-amber); }
    .side-effect-area.low { color: var(--accent-emerald); }

    .side-effect-body {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .side-effect-body strong {
      color: var(--text-primary);
      font-weight: 500;
    }

    /* ========== INFO SECTIONS ========== */
    .info-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      margin-bottom: var(--space-lg);
      overflow: hidden;
    }

    .info-section-header {
      padding: var(--space-md) var(--space-lg);
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-subtle);
    }

    .info-section-content {
      padding: var(--space-lg);
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.7;
    }

    .info-section-content p { margin: var(--space-sm) 0; }
    .info-section-content p:first-child { margin-top: 0; }
    .info-section-content p:last-child { margin-bottom: 0; }

    /* Glossary */
    .glossary-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .glossary-item {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: var(--space-md);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .glossary-item:last-child { border-bottom: none; }

    .glossary-term {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 500;
      color: var(--accent-amber);
    }

    .glossary-definition {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ========== FILE CONTEXT TOOLTIP ========== */
    .file-context-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .file-context-icon {
      width: 14px;
      height: 14px;
      margin-left: var(--space-xs);
      background: var(--accent-lavender);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 16v-4M12 8h.01'/%3E%3C/svg%3E") center/contain no-repeat;
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M12 16v-4M12 8h.01'/%3E%3C/svg%3E") center/contain no-repeat;
      cursor: help;
      opacity: 0.7;
      transition: opacity 0.15s var(--ease-out);
    }

    .file-context-icon:hover { opacity: 1; }

    .file-context-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: var(--space-sm) var(--space-md);
      font-family: var(--font-body);
      font-size: 13px;
      color: var(--text-secondary);
      max-width: 320px;
      white-space: normal;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s var(--ease-out), visibility 0.15s var(--ease-out);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .file-context-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--border-color);
    }

    .file-context-icon:hover + .file-context-tooltip,
    .file-context-tooltip:hover {
      opacity: 1;
      visibility: visible;
    }

    /* ========== NARRATIVE LAYOUT ========== */
    .narrative-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: var(--space-xl);
      min-height: calc(100vh - 200px);
    }

    @media (max-width: 1000px) {
      .narrative-layout { grid-template-columns: 1fr; }
      .sidebar { position: relative; top: 0; max-height: none; }
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 80px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      padding-right: var(--space-md);
    }

    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }

    .sidebar h3 {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border-subtle);
    }

    .step-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
      padding: var(--space-md);
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: var(--space-xs);
      transition: all 0.2s var(--ease-out);
      border: 1px solid transparent;
    }

    .step-item:hover {
      background: var(--bg-secondary);
    }

    .step-item.active {
      background: var(--bg-secondary);
      border-color: var(--border-subtle);
    }

    .step-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      line-height: 1.4;
      transition: color 0.2s var(--ease-out);
    }

    .step-item:hover .step-title,
    .step-item.active .step-title {
      color: var(--text-primary);
    }

    /* Main Content Area */
    .main-content {
      min-width: 0;
    }

    .narrative-summary {
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
      background: var(--bg-secondary);
      border-radius: 12px;
      border-left: 3px solid var(--accent-amber);
      color: var(--text-secondary);
      font-size: 15px;
      font-style: italic;
      line-height: 1.7;
    }

    .step-content {
      margin-bottom: var(--space-2xl);
      animation: fadeIn 0.3s var(--ease-out);
    }

    .step-content:last-child { margin-bottom: 0; }

    .step-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-md);
    }

    .step-number {
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 500;
      color: var(--accent-amber);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--accent-amber);
      border-radius: 50%;
    }

    .step-content h3 {
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    .step-blurb {
      color: var(--text-secondary);
      margin-bottom: var(--space-lg);
      padding-left: 48px;
      font-size: 15px;
      line-height: 1.7;
    }

    /* ========== HUNK/DIFF DISPLAY ========== */
    .hunk {
      margin-bottom: var(--space-lg);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s var(--ease-out);
    }

    .hunk:hover {
      border-color: var(--border-color);
    }

    .hunk-header {
      background: var(--bg-tertiary);
      padding: var(--space-sm) var(--space-md);
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .hunk-file-path {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .hunk-file-path::before {
      content: '';
      width: 12px;
      height: 12px;
      background: var(--text-muted);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'/%3E%3Cpath d='M14 2v6h6'/%3E%3C/svg%3E") center/contain no-repeat;
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpath d='M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'/%3E%3Cpath d='M14 2v6h6'/%3E%3C/svg%3E") center/contain no-repeat;
    }

    .diff-content {
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.6;
      overflow-x: auto;
    }

    .diff-line {
      display: flex;
      min-height: 24px;
    }

    .diff-line.addition {
      background: var(--diff-add-bg);
    }

    .diff-line.deletion {
      background: var(--diff-del-bg);
    }

    .diff-line.hunk-header-line {
      background: var(--accent-sky-dim);
      color: var(--accent-sky);
      font-style: italic;
    }

    .line-number {
      width: 56px;
      padding: 0 var(--space-sm);
      text-align: right;
      color: var(--text-muted);
      user-select: none;
      border-right: 1px solid var(--border-subtle);
      flex-shrink: 0;
      font-size: 12px;
    }

    .line-indicator {
      width: 24px;
      text-align: center;
      color: var(--text-muted);
      flex-shrink: 0;
      font-weight: 500;
    }

    .addition .line-indicator { color: var(--diff-add-text); }
    .deletion .line-indicator { color: var(--diff-del-text); }

    .line-content {
      flex: 1;
      padding: 0 var(--space-md);
      white-space: pre;
    }

    /* ========== ANNOTATIONS ========== */
    .annotation {
      margin: 0;
      padding: var(--space-sm) var(--space-md) var(--space-sm) 88px;
      font-size: 13px;
      border-left: 3px solid;
      font-family: var(--font-body);
      display: flex;
      align-items: baseline;
      gap: var(--space-sm);
    }

    .annotation.provocation {
      background: rgba(139, 148, 158, 0.06);
      border-color: var(--text-muted);
    }

    .annotation.risk {
      background: var(--accent-coral-dim);
      border-color: var(--accent-coral);
    }

    .annotation.edge_case {
      background: var(--accent-amber-dim);
      border-color: var(--accent-amber);
    }

    .annotation.alternative {
      background: var(--accent-sky-dim);
      border-color: var(--accent-sky);
    }

    .annotation.question {
      background: var(--accent-lavender-dim);
      border-color: var(--accent-lavender);
    }

    .annotation-label {
      font-family: var(--font-mono);
      font-weight: 500;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      flex-shrink: 0;
    }

    .provocation .annotation-label { color: var(--text-muted); }
    .risk .annotation-label { color: var(--accent-coral); }
    .edge_case .annotation-label { color: var(--accent-amber); }
    .alternative .annotation-label { color: var(--accent-sky); }
    .question .annotation-label { color: var(--accent-lavender); }

    .annotation-content {
      color: var(--text-secondary);
    }

    /* ========== COPY PROMPT BUTTONS ========== */
    .copy-prompt-section {
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .copy-btn {
      padding: var(--space-xs) var(--space-md);
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s var(--ease-out);
    }

    .copy-btn:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .copy-btn.copied {
      background: var(--accent-emerald);
      color: var(--bg-primary);
      border-color: var(--accent-emerald);
    }

    .copy-btn.added {
      background: var(--accent-amber-dim);
      color: var(--accent-amber);
      border-color: rgba(232, 169, 69, 0.4);
    }

    /* ========== PROMPT PANEL ========== */
    .prompt-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 500;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s var(--ease-out);
    }

    .prompt-panel.empty {
      transform: translateY(calc(100% - 42px));
    }

    .prompt-panel-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-sm) var(--space-lg);
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid var(--border-subtle);
      min-height: 42px;
    }

    .prompt-panel-header:hover {
      background: var(--bg-tertiary);
    }

    .prompt-panel-title {
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
    }

    .prompt-panel-count {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      background: var(--accent-amber);
      color: var(--bg-primary);
      padding: 1px 8px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    .prompt-panel-count.hidden { display: none; }

    .prompt-panel-actions {
      margin-left: auto;
      display: flex;
      gap: var(--space-sm);
      align-items: center;
    }

    .prompt-panel-btn {
      padding: var(--space-xs) var(--space-md);
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s var(--ease-out);
    }

    .prompt-panel-btn:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .prompt-panel-btn.primary {
      background: var(--accent-amber);
      color: var(--bg-primary);
      border-color: var(--accent-amber);
      font-weight: 600;
    }

    .prompt-panel-btn.primary:hover {
      background: #d49a3a;
      border-color: #d49a3a;
    }

    .prompt-panel-btn.primary.copied {
      background: var(--accent-emerald);
      border-color: var(--accent-emerald);
    }

    .prompt-panel-collapse {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s var(--ease-out);
    }

    .prompt-panel.collapsed .prompt-panel-collapse {
      transform: rotate(180deg);
    }

    .prompt-panel-body {
      max-height: 280px;
      overflow-y: auto;
      transition: max-height 0.3s var(--ease-out), opacity 0.2s var(--ease-out);
    }

    .prompt-panel.collapsed .prompt-panel-body {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }

    .prompt-panel-chips {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-lg);
    }

    .prompt-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: 3px 10px;
      border-radius: 14px;
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      border: 1px solid;
      animation: fadeIn 0.2s var(--ease-out);
    }

    .prompt-chip[data-type="edge-cases"] {
      background: var(--accent-amber-dim);
      color: var(--accent-amber);
      border-color: rgba(232, 169, 69, 0.3);
    }

    .prompt-chip[data-type="risk"] {
      background: var(--accent-coral-dim);
      color: var(--accent-coral);
      border-color: rgba(232, 107, 92, 0.3);
    }

    .prompt-chip[data-type="alternatives"] {
      background: var(--accent-sky-dim);
      color: var(--accent-sky);
      border-color: rgba(107, 168, 212, 0.3);
    }

    .prompt-chip[data-type="ask"] {
      background: var(--accent-lavender-dim);
      color: var(--accent-lavender);
      border-color: rgba(168, 143, 212, 0.3);
    }

    .prompt-chip-remove {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      opacity: 0.6;
      padding: 0;
      margin-left: 2px;
    }

    .prompt-chip-remove:hover { opacity: 1; }

    .prompt-panel-preview {
      padding: var(--space-sm) var(--space-lg) var(--space-md);
    }

    .prompt-panel-preview pre {
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-secondary);
      background: var(--bg-primary);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: var(--space-md);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 180px;
      overflow-y: auto;
    }

    .prompt-panel-empty {
      padding: var(--space-md) var(--space-lg);
      color: var(--text-muted);
      font-size: 13px;
      font-style: italic;
      text-align: center;
    }

    /* ========== MARKDOWN RENDERING ========== */
    .markdown strong { font-weight: 600; color: var(--text-primary); }
    .markdown em { font-style: italic; }
    .markdown code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.9em;
      color: var(--accent-amber);
    }
    .markdown ul, .markdown ol { padding-left: var(--space-lg); margin: var(--space-sm) 0; }
    .markdown li { margin: var(--space-xs) 0; }
    .markdown p { margin: var(--space-sm) 0; }
    .markdown p:first-child { margin-top: 0; }
    .markdown p:last-child { margin-bottom: 0; }

    /* ========== SCROLLBAR STYLING ========== */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  </style>
</head>
<body>
  <div class="tab-bar-wrapper">
    <div class="tab-bar" id="tabBar"></div>
  </div>
  <div class="content" id="content"></div>

  <div class="prompt-panel empty" id="promptPanel">
    <div class="prompt-panel-header" id="promptPanelHeader">
      <span class="prompt-panel-title">Prompt Builder</span>
      <span class="prompt-panel-count hidden" id="promptPanelCount">0</span>
      <div class="prompt-panel-actions">
        <button class="prompt-panel-btn" onclick="clearPromptPanel()">Clear</button>
        <button class="prompt-panel-btn primary" id="copyPromptBtn" onclick="copyAssembledPrompt(this)">Copy Prompt</button>
        <button class="prompt-panel-collapse" id="promptPanelCollapseBtn">&#9650;</button>
      </div>
    </div>
    <div class="prompt-panel-body" id="promptPanelBody">
      <div class="prompt-panel-chips" id="promptPanelChips"></div>
      <div class="prompt-panel-preview" id="promptPanelPreview" style="display:none;"><pre id="promptPanelPreviewText"></pre></div>
      <div class="prompt-panel-empty" id="promptPanelEmpty">Click buttons below diffs to build a review prompt...</div>
    </div>
  </div>

  <!-- Analysis data injected at build time -->
  <script>
  const ANALYSIS = /*__DIFFSTORY_ANALYSIS_PLACEHOLDER__*/null;
  </script>
  <script type="module">
    import { codeToTokens } from 'https://esm.sh/shiki@3.0.0';

    // Language detection from file extension
    function detectLanguage(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const langMap = {
        js: 'javascript', ts: 'typescript', tsx: 'tsx', jsx: 'jsx',
        rb: 'ruby', py: 'python', go: 'go', rs: 'rust',
        java: 'java', kt: 'kotlin', swift: 'swift',
        c: 'c', cpp: 'cpp', h: 'c', cs: 'csharp',
        php: 'php', sql: 'sql', sh: 'bash', bash: 'bash', zsh: 'bash',
        yml: 'yaml', yaml: 'yaml', json: 'json',
        html: 'html', css: 'css', scss: 'scss', md: 'markdown',
        ex: 'elixir', exs: 'elixir', vue: 'vue', svelte: 'svelte',
      };
      return langMap[ext] || null;
    }

    // Render tokens with inline color styles
    function renderTokens(tokens) {
      return tokens.map(t =>
        `<span style="color:${t.color || 'inherit'}">${escapeHtml(t.content)}</span>`
      ).join('');
    }

    // Simple markdown parser
    function parseMarkdown(text) {
      if (!text) return '';
      let safe = escapeHtml(text);
      return safe
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code>$1</code>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
        .replace(/(<li>.*<\/li>)/s, (m) => m.startsWith('<ul>') ? m : `<ol>${m}</ol>`);
    }

    // Render diff with line numbers, syntax highlighting, and annotations
    async function renderDiff(hunk) {
      const lines = hunk.diff.split('\n');
      let html = '';
      let lineNum = hunk.startLine;
      const lang = detectLanguage(hunk.file);

      // Group annotations by line
      const annotationsByLine = {};
      (hunk.annotations || []).forEach(a => {
        if (!annotationsByLine[a.line]) annotationsByLine[a.line] = [];
        annotationsByLine[a.line].push(a);
      });

      // Helper to render annotations
      const renderAnnotations = (targetLine) => {
        if (targetLine && annotationsByLine[targetLine]) {
          const labels = {
            provocation: 'Note',
            risk: 'Risk',
            edge_case: 'Edge Case',
            alternative: 'Alternative',
            question: 'Question'
          };
          annotationsByLine[targetLine].forEach(a => {
            html += `<div class="annotation ${a.type}">
              <span class="annotation-label">${labels[a.type] || a.type}</span>
              <span class="annotation-content markdown">${parseMarkdown(a.content)}</span>
            </div>`;
          });
        }
      };

      // Build code content for syntax highlighting (excluding metadata lines)
      const codeLineIndices = [];
      const codeLines = [];
      lines.forEach((line, idx) => {
        if (line.startsWith('@@') || line.startsWith('---') || line.startsWith('+++')) {
          return; // skip metadata
        }
        codeLineIndices.push(idx);
        // Strip the +/- prefix for highlighting
        codeLines.push(line.startsWith('+') || line.startsWith('-') ? line.slice(1) : line);
      });

      // Get tokens from Shiki (or null if no language/error)
      let tokensByLine = null;
      if (lang && codeLines.length > 0) {
        try {
          const code = codeLines.join('\n');
          const result = await codeToTokens(code, { lang, theme: 'vitesse-dark' });
          tokensByLine = result.tokens;
        } catch (e) {
          console.warn('Shiki highlighting failed for', hunk.file, ':', e);
        }
      }

      // Map tokensByLine index back to original line index
      const tokenMap = {};
      if (tokensByLine) {
        codeLineIndices.forEach((origIdx, tokenIdx) => {
          tokenMap[origIdx] = tokensByLine[tokenIdx];
        });
      }

      lines.forEach((line, idx) => {
        let lineClass = '';
        let indicator = ' ';
        let displayLineNum = '';

        if (line.startsWith('@@')) {
          lineClass = 'hunk-header-line';
          // Parse line number from @@ -X,Y +Z,W @@
          const match = line.match(/@@ -\d+(?:,\d+)? \+(\d+)/);
          if (match) lineNum = parseInt(match[1], 10);
        } else if (line.startsWith('+') && !line.startsWith('+++')) {
          lineClass = 'addition';
          indicator = '+';
          displayLineNum = lineNum++;
        } else if (line.startsWith('-') && !line.startsWith('---')) {
          lineClass = 'deletion';
          indicator = '-';
          displayLineNum = '';
        } else if (!line.startsWith('---') && !line.startsWith('+++')) {
          displayLineNum = lineNum++;
        }

        const content = line.startsWith('+') || line.startsWith('-') ? line.slice(1) : line;

        // Use syntax-highlighted tokens if available, otherwise escape
        let renderedContent;
        if (tokenMap[idx]) {
          renderedContent = renderTokens(tokenMap[idx]);
        } else {
          renderedContent = escapeHtml(content);
        }

        html += `<div class="diff-line ${lineClass}">
          <span class="line-number">${displayLineNum}</span>
          <span class="line-indicator">${indicator}</span>
          <span class="line-content">${renderedContent}</span>
        </div>`;

        // Render annotations immediately below their target line
        if (displayLineNum) {
          renderAnnotations(displayLineNum);
        }
      });

      return html;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== PROMPT BUILDER ==========
    const promptBuilder = { items: [], collapsed: false };

    const PROMPT_TYPE_LABELS = {
      'edge-cases': 'Edge Cases',
      'risk': 'Risk',
      'alternatives': 'Alternatives',
      'ask': 'Ask'
    };

    function entryId(type, hunkId) {
      return `${type}::${hunkId}`;
    }

    function hasEntry(type, hunkId) {
      return promptBuilder.items.some(item => item.id === entryId(type, hunkId));
    }

    function addEntry(type, hunkId) {
      if (hasEntry(type, hunkId)) return;
      const hunk = findHunk(hunkId);
      if (!hunk) return;
      promptBuilder.items.push({
        id: entryId(type, hunkId),
        type,
        hunkId,
        file: hunk.file,
        startLine: hunk.startLine,
        endLine: hunk.endLine,
        diff: hunk.diff
      });
      updatePanel();
      updateHunkButtons(hunkId);
    }

    function removeEntry(type, hunkId) {
      promptBuilder.items = promptBuilder.items.filter(item => item.id !== entryId(type, hunkId));
      updatePanel();
      updateHunkButtons(hunkId);
    }

    function toggleEntry(type, hunkId) {
      if (hasEntry(type, hunkId)) {
        removeEntry(type, hunkId);
      } else {
        addEntry(type, hunkId);
      }
    }

    function clearAllEntries() {
      const affectedHunks = [...new Set(promptBuilder.items.map(i => i.hunkId))];
      promptBuilder.items = [];
      updatePanel();
      affectedHunks.forEach(hunkId => updateHunkButtons(hunkId));
    }

    function assemblePrompt() {
      const items = promptBuilder.items;
      if (items.length === 0) return '';

      const typeGroups = {};
      items.forEach(item => {
        if (!typeGroups[item.type]) typeGroups[item.type] = [];
        typeGroups[item.type].push(item);
      });

      const types = Object.keys(typeGroups);
      const allHunkIds = [...new Set(items.map(i => i.hunkId))];

      const typeIntros = {
        'edge-cases': 'Analyze for potential edge cases and boundary conditions that might not be handled correctly. Focus on input validation, boundary conditions (empty arrays, null values, zero, negative numbers), concurrent access, resource limits, and error propagation paths.',
        'risk': 'Analyze for potential risks including security vulnerabilities, performance regressions, breaking changes to public APIs, data integrity issues, and production stability concerns. Rate the overall risk as low/medium/high.',
        'alternatives': 'Suggest alternative approaches that might be more readable, performant, maintainable, or idiomatic. Only suggest alternatives if they provide meaningful improvements.',
        'ask': 'I have a question about this code:'
      };

      let prompt = '';

      if (types.length === 1) {
        const type = types[0];
        const group = typeGroups[type];
        prompt += `${typeIntros[type]}\n`;
        group.forEach(item => {
          prompt += `\n--- ${item.file} (lines ${item.startLine}–${item.endLine}) ---\n${item.diff}\n`;
        });
      } else {
        prompt += 'Please review the following code changes:\n';
        items.forEach(item => {
          prompt += `\n--- ${item.file} (lines ${item.startLine}–${item.endLine}) ---\n${item.diff}\n`;
        });
        prompt += '\nFor these changes, please:\n';
        types.forEach(type => {
          const files = typeGroups[type].map(i => `${i.file}:${i.startLine}`).join(', ');
          prompt += `\n• ${PROMPT_TYPE_LABELS[type]} (${files}): ${typeIntros[type]}`;
        });
        prompt += '\n';
      }

      return prompt.trim();
    }

    function updatePanel() {
      const panel = document.getElementById('promptPanel');
      const chips = document.getElementById('promptPanelChips');
      const preview = document.getElementById('promptPanelPreview');
      const previewText = document.getElementById('promptPanelPreviewText');
      const empty = document.getElementById('promptPanelEmpty');
      const count = document.getElementById('promptPanelCount');

      const hasItems = promptBuilder.items.length > 0;

      panel.classList.toggle('empty', !hasItems);
      count.classList.toggle('hidden', !hasItems);
      count.textContent = promptBuilder.items.length;

      if (hasItems) {
        chips.innerHTML = promptBuilder.items.map(item => {
          const shortFile = item.file.split('/').pop();
          return `<span class="prompt-chip" data-type="${item.type}">
            ${PROMPT_TYPE_LABELS[item.type]}: ${escapeHtml(shortFile)}
            <button class="prompt-chip-remove" onclick="removePromptEntry('${item.type}', '${item.hunkId}')">&times;</button>
          </span>`;
        }).join('');

        preview.style.display = '';
        previewText.textContent = assemblePrompt();
        empty.style.display = 'none';
      } else {
        chips.innerHTML = '';
        preview.style.display = 'none';
        empty.style.display = '';
      }

      updateContentPadding();
    }

    function updateHunkButtons(hunkId) {
      const hunkEl = document.querySelector(`.hunk[data-hunk-id="${hunkId}"]`);
      if (!hunkEl) return;
      hunkEl.querySelectorAll('.copy-btn[data-type]').forEach(btn => {
        const type = btn.dataset.type;
        const active = hasEntry(type, hunkId);
        btn.classList.toggle('added', active);
        btn.textContent = active ? `✓ ${PROMPT_TYPE_LABELS[type]}` : PROMPT_TYPE_LABELS[type];
      });
    }

    function refreshAllHunkButtons() {
      document.querySelectorAll('.hunk[data-hunk-id]').forEach(hunkEl => {
        updateHunkButtons(hunkEl.dataset.hunkId);
      });
    }

    function updateContentPadding() {
      const panel = document.getElementById('promptPanel');
      const content = document.getElementById('content');
      if (panel && content) {
        content.style.paddingBottom = panel.offsetHeight + 'px';
      }
    }

    function initPanel() {
      const header = document.getElementById('promptPanelHeader');
      const collapseBtn = document.getElementById('promptPanelCollapseBtn');
      const panel = document.getElementById('promptPanel');

      collapseBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        promptBuilder.collapsed = !promptBuilder.collapsed;
        panel.classList.toggle('collapsed', promptBuilder.collapsed);
        updateContentPadding();
      });

      header.addEventListener('click', (e) => {
        if (e.target.closest('.prompt-panel-btn') || e.target.closest('.prompt-panel-collapse')) return;
        promptBuilder.collapsed = !promptBuilder.collapsed;
        panel.classList.toggle('collapsed', promptBuilder.collapsed);
        updateContentPadding();
      });

      updateContentPadding();
    }

    // Render file context tooltip if present
    function renderFileContext(hunk) {
      if (!hunk.fileContext) return '';
      return `
        <span class="file-context-wrapper">
          <span class="file-context-icon"></span>
          <span class="file-context-tooltip">${escapeHtml(hunk.fileContext)}</span>
        </span>
      `;
    }

    // Render hunk with controls
    async function renderHunk(hunk) {
      const diffHtml = await renderDiff(hunk);

      return `
        <div class="hunk" data-hunk-id="${hunk.id}">
          <div class="hunk-header">
            <span class="hunk-file-path">${escapeHtml(hunk.file)}${renderFileContext(hunk)} <span style="color: var(--text-muted)">lines ${hunk.startLine}–${hunk.endLine}</span></span>
          </div>
          <div class="diff-content">
            ${diffHtml}
          </div>
          <div class="copy-prompt-section">
            <button class="copy-btn" data-type="edge-cases" data-hunk="${hunk.id}" onclick="togglePromptEntry('edge-cases', '${hunk.id}')">Edge Cases</button>
            <button class="copy-btn" data-type="risk" data-hunk="${hunk.id}" onclick="togglePromptEntry('risk', '${hunk.id}')">Risk</button>
            <button class="copy-btn" data-type="alternatives" data-hunk="${hunk.id}" onclick="togglePromptEntry('alternatives', '${hunk.id}')">Alternatives</button>
            <button class="copy-btn" data-type="ask" data-hunk="${hunk.id}" onclick="togglePromptEntry('ask', '${hunk.id}')">Ask</button>
          </div>
        </div>
      `;
    }

    // Global handlers
    window.togglePromptEntry = function(type, hunkId) {
      toggleEntry(type, hunkId);
    };

    window.removePromptEntry = function(type, hunkId) {
      removeEntry(type, hunkId);
    };

    window.clearPromptPanel = function() {
      clearAllEntries();
    };

    window.copyAssembledPrompt = function(btn) {
      const text = assemblePrompt();
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('copied');
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.textContent = 'Copy Prompt';
        }, 2000);
      });
    };

    function findHunk(hunkId) {
      for (const n of ANALYSIS.narratives) {
        for (const s of n.steps) {
          for (const h of s.hunks) {
            if (h.id === hunkId) return h;
          }
        }
      }
      return null;
    }

    // Render tabs
    function renderTabs() {
      const tabBar = document.getElementById('tabBar');
      const audienceLabels = {
        none: 'newcomer view',
        basic: 'basic view',
        intermediate: 'standard view',
        expert: 'expert view'
      };
      const audienceLabel = audienceLabels[ANALYSIS.knowledgeLevel] || '';
      let html = `<div class="tab-bar-brand"><span class="tab-bar-brand-name">DIFFSTORY</span>${audienceLabel ? `<span class="tab-bar-brand-audience">${audienceLabel}</span>` : ''}</div>`;
      html += '<div class="tab active" data-tab="overview">Overview</div>';

      ANALYSIS.narratives.forEach((n, i) => {
        html += `<div class="tab" data-tab="narrative-${i}">${escapeHtml(n.title)}</div>`;
      });

      tabBar.innerHTML = html;

      // Tab click handlers
      tabBar.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', async () => {
          tabBar.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          await showTab(tab.dataset.tab);
        });
      });
    }

    // Render side effects section
    function renderSideEffects() {
      if (!ANALYSIS.sideEffects || ANALYSIS.sideEffects.length === 0) return '';
      return `
        <div class="side-effects-section">
          <h3>Side Effects</h3>
          ${ANALYSIS.sideEffects.map(se => `
            <div class="side-effect-item">
              <span class="side-effect-area ${se.severity}">${escapeHtml(se.severity)}</span>
              <div class="side-effect-body markdown"><strong>${escapeHtml(se.area)}</strong> — ${parseMarkdown(se.description)}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Render approach evaluation section
    function renderApproachEvaluation() {
      if (!ANALYSIS.approachEvaluation) return '';
      const ae = ANALYSIS.approachEvaluation;
      const verdicts = ['suboptimal', 'acceptable', 'optimal'];
      const verdictScale = verdicts.map(v => {
        const isActive = v === ae.verdict;
        const cls = isActive ? `verdict-option verdict-active verdict-${v}` : 'verdict-option';
        return `<span class="${cls}">${v.charAt(0).toUpperCase() + v.slice(1)}</span>`;
      }).join('<span class="verdict-sep">/</span>');
      const perspectivesHtml = ae.perspectives && ae.perspectives.length > 0 ? `
        <div class="perspective-cards">
          ${ae.perspectives.map(p => {
            const labels = { maintainer: 'Maintainer', security: 'Security', sre: 'SRE', spec: 'Spec', consumer: 'Consumer' };
            return `<div class="perspective-card ${p.role}">
              <span class="perspective-label">${labels[p.role] || p.role}</span>
              <span class="perspective-concern markdown">${parseMarkdown(p.concern)}</span>
              <span class="perspective-severity ${p.severity}">${p.severity}</span>
            </div>`;
          }).join('')}
        </div>
      ` : '';
      const alternativesHtml = ae.alternatives && ae.alternatives.length > 0 ? `
        <div class="approach-alternatives-header">Alternative Ideas</div>
        <ul class="approach-alternatives">
          ${ae.alternatives.map(a => `<li><span class="approach-alt-title">${escapeHtml(a.title)}</span> — <span class="approach-alt-desc markdown">${parseMarkdown(a.description)}</span></li>`).join('')}
        </ul>
      ` : '';
      return `
        <div class="info-section approach-section">
          <div class="info-section-header">Approach Critique</div>
          <div class="info-section-content">
            <span class="verdict-scale"><span class="verdict-bracket">[</span>${verdictScale}<span class="verdict-bracket">]</span></span>
            <div class="markdown" style="margin-top: var(--space-sm);"><p>${parseMarkdown(ae.summary)}</p></div>
            ${perspectivesHtml}
            ${alternativesHtml}
          </div>
        </div>
      `;
    }

    // Render glossary section
    function renderGlossary() {
      if (!ANALYSIS.glossary || ANALYSIS.glossary.length === 0) return '';
      return `
        <div class="info-section">
          <div class="info-section-header">Glossary</div>
          <div class="info-section-content">
            <div class="glossary-list">
              ${ANALYSIS.glossary.map(g => `
                <div class="glossary-item">
                  <span class="glossary-term">${escapeHtml(g.term)}</span>
                  <span class="glossary-definition markdown">${parseMarkdown(g.definition)}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Render narrative overview (table of contents)
    function renderNarrativeOverview() {
      if (!ANALYSIS.narratives || ANALYSIS.narratives.length === 0) return '';
      const items = ANALYSIS.narratives.map((n, i) => `
        <div class="narrative-toc-item" data-narrative-idx="${i}">
          <div class="narrative-toc-title">${escapeHtml(n.title)}</div>
          <div class="narrative-toc-summary markdown">${parseMarkdown(n.summary)}</div>
        </div>
      `).join('');
      return `
        <div class="info-section narrative-toc">
          <div class="info-section-header">Narrative Overview</div>
          <div class="info-section-content">${items}</div>
        </div>
      `;
    }

    // Render overview tab
    function renderOverview() {
      let coverageHtml = '';
      if (ANALYSIS.testCoverage && ANALYSIS.testCoverage.length > 0) {
        coverageHtml = `
          <div class="coverage-section">
            <h3>Test Coverage</h3>
            ${ANALYSIS.testCoverage.map(c => `
              <div class="coverage-item">
                <span class="coverage-status ${c.status}">${c.status}</span>
                <span class="coverage-file">${escapeHtml(c.file)}::${escapeHtml(c.function)}</span>
                ${c.notes ? `<span class="coverage-notes markdown">${parseMarkdown(c.notes)}</span>` : ''}
              </div>
            `).join('')}
          </div>
        `;
      } else {
        coverageHtml = `
          <div class="coverage-section">
            <h3>Test Coverage</h3>
            <p style="color: var(--text-muted); font-size: 14px; font-style: italic;">No tests in this PR.</p>
          </div>
        `;
      }

      const hasExplanation = ANALYSIS.criticality.explanation;
      const hasRisks = ANALYSIS.criticality.risks && ANALYSIS.criticality.risks.length > 0;
      const risksHtml = (hasExplanation || hasRisks) ? `
        <div class="info-section">
          <div class="info-section-header">Risks &amp; Impact</div>
          <div class="info-section-content">
            <div style="margin-bottom: var(--space-md);"><span class="badge ${ANALYSIS.criticality.level}">${ANALYSIS.criticality.level} criticality</span></div>
            ${hasExplanation ? `<div class="criticality-explanation markdown"><p>${parseMarkdown(ANALYSIS.criticality.explanation)}</p></div>` : ''}
            ${hasRisks ? `<h4 class="section-subheading">Other Risks</h4>
            <ul class="criticality-reasons">
              ${ANALYSIS.criticality.risks.map(r => `<li>${escapeHtml(r)}</li>`).join('')}
            </ul>` : ''}
          </div>
        </div>
      ` : '';

      const bigPictureContent = ANALYSIS.bigPicture
        ? `<div class="info-section-content markdown"><p>${parseMarkdown(ANALYSIS.bigPicture)}</p></div>
           <div class="info-section-content markdown" style="border-top: 1px solid var(--border-subtle);"><p>${parseMarkdown(ANALYSIS.summary)}</p></div>`
        : `<div class="info-section-content markdown"><p>${parseMarkdown(ANALYSIS.summary)}</p></div>`;

      return `
        <div class="overview-header">
          <h1 class="overview-title">${escapeHtml(ANALYSIS.title)}</h1>
        </div>

        <div class="summary">
          <h3>The Big Picture</h3>
          ${bigPictureContent}
        </div>

        ${renderNarrativeOverview()}

        ${renderGlossary()}

        ${risksHtml}

        ${renderSideEffects()}

        ${renderApproachEvaluation()}

        ${coverageHtml}
      `;
    }

    // Render narrative tab
    async function renderNarrative(narrative) {
      const stepsHtml = narrative.steps.map((step, i) => {
        return `
          <div class="step-item ${i === 0 ? 'active' : ''}" data-step="${step.id}">
            <div class="step-title">${escapeHtml(step.title)}</div>
          </div>
        `;
      }).join('');

      // Render all hunks async
      const stepContents = await Promise.all(narrative.steps.map(async (step, i) => {
        const hunksHtml = await Promise.all(step.hunks.map(h => renderHunk(h)));
        return `
          <div class="step-content" data-step-content="${step.id}">
            <div class="step-header">
              <span class="step-number">${i + 1}</span>
              <h3>${escapeHtml(step.title)}</h3>
            </div>
            <div class="step-blurb markdown"><p>${parseMarkdown(step.blurb)}</p></div>
            ${hunksHtml.join('')}
          </div>
        `;
      }));

      const narrativeBigPicture = narrative.bigPicture ? `
        <div class="info-section">
          <div class="info-section-header">The Big Picture</div>
          <div class="info-section-content markdown"><p>${parseMarkdown(narrative.bigPicture)}</p></div>
        </div>
      ` : '';

      return `
        <div class="narrative-layout">
          <div class="sidebar">
            <h3>Steps</h3>
            ${stepsHtml}
          </div>
          <div class="main-content">
            ${narrativeBigPicture}
            <div class="narrative-summary markdown"><p>${parseMarkdown(narrative.summary)}</p></div>
            ${stepContents.join('')}
          </div>
        </div>
      `;
    }

    // Navigate to a narrative tab by index
    function navigateToNarrative(idx) {
      const tabBar = document.getElementById('tabBar');
      const tabs = tabBar.querySelectorAll('.tab');
      // tabs: Overview, narrative-0, narrative-1, ...
      const targetTab = tabs[idx + 1]; // +1 to skip Overview
      if (targetTab) {
        tabs.forEach(t => t.classList.remove('active'));
        targetTab.classList.add('active');
        showTab(`narrative-${idx}`);
      }
    }

    // Show tab content
    async function showTab(tabId) {
      window.scrollTo(0, 0);
      const content = document.getElementById('content');

      if (tabId === 'overview') {
        content.innerHTML = renderOverview();
        // Set up narrative TOC click handlers
        content.querySelectorAll('.narrative-toc-item').forEach(item => {
          item.addEventListener('click', () => {
            navigateToNarrative(parseInt(item.dataset.narrativeIdx, 10));
          });
        });
      } else if (tabId.startsWith('narrative-')) {
        const idx = parseInt(tabId.split('-')[1], 10);
        content.innerHTML = await renderNarrative(ANALYSIS.narratives[idx]);
        refreshAllHunkButtons();

        // Set up step click handlers
        content.querySelectorAll('.step-item').forEach(item => {
          item.addEventListener('click', () => {
            content.querySelectorAll('.step-item').forEach(s => s.classList.remove('active'));
            item.classList.add('active');
            const stepId = item.dataset.step;
            const stepContent = content.querySelector(`[data-step-content="${stepId}"]`);
            if (stepContent) {
              stepContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        });
      }
    }

    // Initialize
    (async () => {
      renderTabs();
      initPanel();
      await showTab('overview');
    })();
  </script>
</body>
</html>
